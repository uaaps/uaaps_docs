{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://uaaps.github.io/uaaps_docs/schemas/package-manifest.schema.json",
  "title": "UAAPS Package Manifest",
  "description": "Schema for package.agent.json (and package.agent.yaml) — the single required file in every UAAPS package.",
  "type": "object",
  "required": ["name", "version"],
  "additionalProperties": false,
  "patternProperties": {
    "^x-": {
      "description": "Vendor extension field. Any additional properties prefixed with 'x-' are allowed.",
      "type": "object"
    }
  },
  "properties": {
    "name": {
      "description": "Package name. Either a plain name [a-z0-9-] (max 64 chars) or a scoped name @scope/name (max 130 chars total).",
      "type": "string",
      "pattern": "^(@[a-z0-9][a-z0-9_-]{0,63}/)?[a-z0-9][a-z0-9-]{0,63}$",
      "maxLength": 130
    },
    "version": {
      "description": "Package version following Semantic Versioning 2.0.",
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$"
    },
    "description": {
      "description": "Short human-readable description. Max 1024 chars.",
      "type": "string",
      "maxLength": 1024
    },
    "author": {
      "description": "Author name or organization identifier.",
      "type": "string"
    },
    "license": {
      "description": "SPDX license identifier or filename (e.g. 'Apache-2.0', 'LICENSE').",
      "type": "string"
    },
    "repository": {
      "description": "URL to the source code repository.",
      "type": "string",
      "format": "uri"
    },
    "homepage": {
      "description": "URL to the project homepage or documentation.",
      "type": "string",
      "format": "uri"
    },
    "category": {
      "description": "Marketplace category for discovery.",
      "type": "string"
    },
    "keywords": {
      "description": "Discovery tags for registry search.",
      "type": "array",
      "items": { "type": "string" },
      "uniqueItems": true
    },
    "engines": {
      "description": "Minimum platform version requirements.",
      "type": "object",
      "properties": {
        "claude-code": { "type": "string" },
        "cursor":      { "type": "string" },
        "copilot":     { "type": "string" },
        "codex":       { "type": "string" }
      },
      "additionalProperties": { "type": "string" }
    },
    "artifacts": {
      "description": "Explicit artifact registry. Optional; artifacts are auto-discovered if omitted.",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "skills": {
          "type": "array",
          "items": { "$ref": "#/$defs/artifactEntry" }
        },
        "agents": {
          "type": "array",
          "items": { "$ref": "#/$defs/artifactEntry" }
        },
        "commands": {
          "type": "array",
          "items": { "$ref": "#/$defs/artifactEntry" }
        }
      }
    },
    "dependencies": {
      "description": "Other UAAPS packages required. Keys are package names, values are SemVer ranges.",
      "$ref": "#/$defs/dependencyMap"
    },
    "optionalDependencies": {
      "description": "Optional packages — install succeeds even if these are absent.",
      "$ref": "#/$defs/dependencyMap"
    },
    "peerDependencies": {
      "description": "Packages that must be provided by the host environment. Not auto-installed.",
      "$ref": "#/$defs/dependencyMap"
    },
    "resolutions": {
      "description": "Force specific versions for transitive dependencies to resolve conflicts.",
      "$ref": "#/$defs/dependencyMap"
    },
    "systemDependencies": {
      "description": "OS-level and runtime requirements. Verified via pre-flight checks; not auto-installed (except pip/npm with --install-system-deps).",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "python": {
          "description": "Required Python version (SemVer range, e.g. '>=3.10').",
          "type": "string"
        },
        "node": {
          "description": "Required Node.js version (SemVer range, e.g. '>=18').",
          "type": "string"
        },
        "packages": {
          "description": "Packages to install via package managers.",
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "pip":   { "type": "array", "items": { "type": "string" } },
            "npm":   { "type": "array", "items": { "type": "string" } },
            "brew":  { "type": "array", "items": { "type": "string" } },
            "apt":   { "type": "array", "items": { "type": "string" } },
            "cargo": { "type": "array", "items": { "type": "string" } }
          }
        },
        "binaries": {
          "description": "Executables that must exist on $PATH.",
          "type": "array",
          "items": { "type": "string" }
        },
        "mcp-servers": {
          "description": "MCP server names that must be available.",
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "env": {
      "description": "Environment variables required by this package.",
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "required": ["description"],
        "additionalProperties": false,
        "properties": {
          "description": { "type": "string" },
          "required":    { "type": "boolean" },
          "default":     { "type": "string" }
        }
      }
    },
    "permissions": {
      "description": "Declared capability scopes. When present, platforms MUST enforce these at runtime. See §17.1.",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "fs": {
          "description": "Filesystem access scopes.",
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "read": {
              "description": "Glob patterns the package MAY read. Paths are relative to the project root.",
              "type": "array",
              "items": { "type": "string" }
            },
            "write": {
              "description": "Glob patterns the package MAY write or delete. A write grant does not imply read.",
              "type": "array",
              "items": { "type": "string" }
            }
          }
        },
        "network": {
          "description": "Network access scopes. Omitting network entirely means no network access is permitted.",
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "hosts": {
              "description": "Allowed hostnames (exact or single-level wildcard like '*.example.com'). IP literals and CIDR ranges are not supported.",
              "type": "array",
              "items": { "type": "string" }
            },
            "schemes": {
              "description": "Allowed URI schemes. Permitted values: https, http, wss, ws. Defaults to ['https'] if omitted.",
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["https", "http", "wss", "ws"]
              }
            }
          }
        },
        "shell": {
          "description": "Shell execution scopes.",
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "allow": {
              "description": "Whether shell execution is permitted. false (or omitting shell) prohibits all shell execution.",
              "type": "boolean"
            },
            "binaries": {
              "description": "When present, only listed executable names MAY be invoked. Matched against the basename of the resolved executable.",
              "type": "array",
              "items": { "type": "string" }
            }
          }
        }
      }
    },
    "permissionGrants": {
      "description": "Explicit permission escalations for specific dependencies. Keys MUST be package names from dependencies. See §17.3.",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/permissionsObject"
      }
    },
    "resolverVersion": {
      "description": "Dependency resolution algorithm version. Must be a positive integer. Unknown versions are a fatal error. See §13.4.",
      "type": "integer",
      "minimum": 1,
      "default": 1
    },
    "installMode": {
      "description": "Installation mode. A string for uniform mode, or an object with 'default' and per-platform overrides. See §12.1.",
      "oneOf": [
        {
          "type": "string",
          "enum": ["project", "global"]
        },
        {
          "type": "object",
          "required": ["default"],
          "additionalProperties": false,
          "properties": {
            "default":    { "type": "string", "enum": ["project", "global"] },
            "claude-code": { "type": "string", "enum": ["project", "global"] },
            "cursor":      { "type": "string", "enum": ["project", "global"] },
            "copilot":     { "type": "string", "enum": ["project", "global"] },
            "codex":       { "type": "string", "enum": ["project", "global"] }
          }
        }
      ]
    },
    "deprecated": {
      "description": "When present, marks this version as deprecated. The message field is REQUIRED.",
      "type": "object",
      "required": ["message"],
      "additionalProperties": false,
      "properties": {
        "message": {
          "description": "Human-readable deprecation notice. Should include migration guidance.",
          "type": "string"
        },
        "successor": {
          "description": "Suggested replacement package name or version range.",
          "type": "string"
        }
      }
    },
    "quality": {
      "description": "Tests and evals definitions.",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "tests": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "command"],
            "additionalProperties": false,
            "properties": {
              "name":        { "type": "string" },
              "command":     { "type": "string" },
              "description": { "type": "string" }
            }
          }
        },
        "evals": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "path"],
            "additionalProperties": false,
            "properties": {
              "name":        { "type": "string" },
              "path":        { "type": "string" },
              "description": { "type": "string" },
              "metrics": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["name", "type"],
                  "properties": {
                    "name": { "type": "string" },
                    "type": { "type": "string" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "skills":   { "description": "Override path to skills directory.", "type": "string" },
    "commands": { "description": "Override path to commands directory.", "type": "string" },
    "agents":   { "description": "Override path to agents directory.", "type": "string" },
    "rules":    { "description": "Override path to rules directory.", "type": "string" },
    "hooks":    { "description": "Override path to hooks.json.", "type": "string" },
    "mcp":      { "description": "Override path to MCP servers.json.", "type": "string" },
    "dist-tags": {
      "description": "Named aliases for specific package versions (e.g. 'stable', 'bank-approved').",
      "$ref": "#/$defs/dependencyMap"
    },
    "x-claude": {
      "description": "Claude Code vendor extension fields.",
      "type": "object"
    },
    "x-cursor": {
      "description": "Cursor vendor extension fields.",
      "type": "object"
    }
  },
  "$defs": {
    "artifactEntry": {
      "type": "object",
      "required": ["name", "path"],
      "additionalProperties": false,
      "properties": {
        "name":        { "type": "string" },
        "path":        { "type": "string" },
        "description": { "type": "string", "maxLength": 1024 }
      }
    },
    "dependencyMap": {
      "type": "object",
      "additionalProperties": { "type": "string" }
    },
    "permissionsObject": {
      "description": "A permissions object matching the structure of the top-level permissions field.",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "fs": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "read":  { "type": "array", "items": { "type": "string" } },
            "write": { "type": "array", "items": { "type": "string" } }
          }
        },
        "network": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "hosts":   { "type": "array", "items": { "type": "string" } },
            "schemes": { "type": "array", "items": { "type": "string", "enum": ["https", "http", "wss", "ws"] } }
          }
        },
        "shell": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "allow":    { "type": "boolean" },
            "binaries": { "type": "array", "items": { "type": "string" } }
          }
        }
      }
    }
  }
}
